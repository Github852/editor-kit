{"version":3,"sources":["webpack:///webpack/bootstrap be33e3a81eb9ec0e68bb","webpack:///./src/lib/Util.js","webpack:///./src/EditorKit.js","webpack:///./src/lib/EditorKitInternal.js","webpack:///../src/componentManager.js","webpack:///./src/lib/FileLoader.js","webpack:///./src/lib/TextExpander.js","webpack:///./src/lib/FilesafeHtml.js","webpack:///external \"filesafe-js\"","webpack:///./src/EditorKitDelegate.js"],"names":["Util","html","tmp","document","implementation","createHTMLDocument","body","innerHTML","textContent","innerText","string","limit","length","substring","seconds","Promise","resolve","reject","setTimeout","EditorKit","delegate","mode","supportsFilesafe","coallesedSavingDelay","internal","EditorKitInternal","getFilesafe","text","onEditorValueChanged","key","isSpace","isEnter","onEditorKeyUp","file","uploadJSFileObject","fileIdsPendingAssociation","connectToBridge","filesafeImportPromise","importFilesafe","then","result","FilesafeClass","configureFilesafe","filesafe","console","log","componentManager","addDataChangeObserver","allFileDescriptors","getAllFileDescriptors","note","hasMatch","uuid","descriptor","find","candidate","addItemAsRelationship","saveItem","splice","indexOf","syntax","FilesafeHtml","insertionSyntaxForFileDescriptor","insertRawText","slice","textExpander","searchPatterns","fileLoader","loadFilesafeElements","addNewFileDescriptorHandler","fileDescriptor","push","FileLoader","getElementsBySelector","insertElement","preprocessElement","TextExpander","afterExpand","getCurrentLineText","getPreviousLineText","replaceText","patterns","regex","FilesafeSyntaxPattern","callback","matchedText","expandedFilesafeSyntax","ComponentManager","documentElement","classList","add","platform","streamContextItem","itemClass","getSFItemClass","isNewNoteLoad","setCurrentNote","isMetadataUpdate","content","previousText","needsFilesafeElementLoad","setEditorRawText","clearUndoHistory","onKeyUp","collapseFilesafeSyntax","sameText","saveItemWithPresave","preview_plain","truncateString","htmlToText","status","insertStatusAtCursor","encryptAndUploadJavaScriptFileObject","removeCursorStatus","messageHandler","event","data","mobileSource","JSON","window","payload","originalMessage","message","alert","value","componentData","action","messageId","sessionKey","api","sentMessage","type","width","height","permissions","contentTypes","Array","content_types","item","items","mapped","content_type","params","skipDebouncer","presave","saveBlock","mappedUuids","mappedItems","itemsToSave","clearTimeout","copy","Object","AppDomain","incomingUrls","themesToActivate","themesToDeactivate","activeUrl","theme","url","link","btoa","elements","element","crypto","buf","idx","r","v","c","d","performance","Math","module","uuidToFileTempUrlAndTypeMapping","currentlyLoadingIds","statusElementMapping","fileTypeToElementType","toLowerCase","loadFilesafeElement","fsElement","fsid","getAttribute","fsname","existingMapping","insertMediaElement","fileType","includes","findFileDescriptor","setStatus","success","selectorSyntax","existingElements","querySelectorAll","cleanup","sleep","downloadFileFromDescriptor","downloadError","fileItem","decryptFile","decryptError","tempUrl","createTemporaryFileUrl","base64Data","decryptedData","dataType","elementType","fileTypeForElementType","mediaElement","createImageElement","createVideoElement","createAudioElement","insertElementAdjacent","remove","figure","createElement","setAttribute","append","image","video","source","wrapElementInFigure","audio","existingStatusElement","identifier","random","toString","domNodeToInsert","adjacentToElement","processedElement","beforeExpand","searchPreviousLine","pattern","match","exec","replaceWith","replaceSelection","replacement","previousLine","replace","filesafeSyntaxToHtmlElement","fileName","components","split","name","size","sizeString","dimensions","domCopy","DOMParser","parseFromString","mediaElements","pTags","pTagsToRemoveCandidates","pTag","numGhosts","numChildren","children","fsSyntax","join","insertAdjacentText","ghosts","forEach","ghost","trim","EditorKitDelegate","onReceiveNote"],"mappings":"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","file":"./editor-kit.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap be33e3a81eb9ec0e68bb","export default class Util {\n  static htmlToText(html) {\n    var tmp = document.implementation.createHTMLDocument(\"New\").body;\n    tmp.innerHTML = html;\n    return tmp.textContent || tmp.innerText || \"\";\n  }\n\n  static truncateString(string, limit = 90) {\n    if(string.length <= limit) {\n      return string;\n    } else {\n      return string.substring(0, limit) + \"...\";\n    }\n  }\n\n  static sleep(seconds) {\n    return new Promise((resolve, reject) => {\n      setTimeout(function () {\n        resolve();\n      }, seconds * 1000);\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/Util.js","import EditorKitInternal from \"./lib/EditorKitInternal\";\nimport EditorKitDelegate from \"./EditorKitDelegate\"\n\nclass EditorKit {\n\n  /*\n    @param EditorKitDelegate `delegate`: The instance responsible for handling editor-specific events\n    @param string `mode`: one of 'plaintext', 'html', 'markdown'\n    @param bool `supportsFilesafe`\n    @param int `coallesedSavingDelay`:\n      For ComponentManager saving, what the debouncer ms delay should be set to.\n      Defaults to 250ms.\n  */\n  constructor({delegate, mode = 'plaintext', supportsFilesafe = false, coallesedSavingDelay = 250}) {\n    this.delegate = delegate;\n    this.mode = mode;\n    this.supportsFilesafe = supportsFilesafe;\n    this.coallesedSavingDelay = coallesedSavingDelay;\n\n    this.internal = new EditorKitInternal({delegate, mode, supportsFilesafe, coallesedSavingDelay});\n  }\n\n  /*\n  Public\n  */\n\n  async getFilesafe() {\n    return this.internal.getFilesafe();\n  }\n\n  /*\n    Called by consumer when the editor has a change/input event\n  */\n  onEditorValueChanged(text) {\n    this.internal.onEditorValueChanged(text);\n  }\n\n  /*\n    Called by consumer when the editor has a keyup event\n  */\n  onEditorKeyUp({key, isSpace, isEnter}) {\n    this.internal.onEditorKeyUp({key, isSpace, isEnter});\n  }\n\n  /*\n    Returns a file descriptor if successful.\n   */\n  async uploadJSFileObject(file) {\n    return this.internal.uploadJSFileObject(file);\n  }\n}\n\nexport {EditorKit, EditorKitDelegate}\n\n\n\n// WEBPACK FOOTER //\n// ./src/EditorKit.js","import ComponentManager from 'sn-components-api';\n\nimport Util from \"./Util.js\"\nimport FileLoader from \"./FileLoader.js\"\nimport TextExpander from \"./TextExpander.js\"\nimport FilesafeHtml from \"./FilesafeHtml.js\"\n\nexport default class EditorKit {\n\n  constructor({delegate, mode, supportsFilesafe, coallesedSavingDelay = 250}) {\n    this.delegate = delegate;\n    this.mode = mode;\n    this.supportsFilesafe = supportsFilesafe;\n    this.coallesedSavingDelay = coallesedSavingDelay;\n\n    /*\n      When we upload a file, we want to associate it with the current note.\n      The best way to ensure that files are in sync with the filesafe client is to wait\n      until the componentMananger has received the file descriptor item back from SN.\n      So, upon being notified that files have changed, we'll sift through this array\n      and associate any pending files.\n     */\n    this.fileIdsPendingAssociation = [];\n\n    this.connectToBridge();\n\n    // Conditionally import filesafe-js. This way, consumers using editor-kit\n    // who don't want FileSafe support don't have to import a large module.\n    // Consumers who do want FileSafe support must include filesafe-js in their own package.json\n    // Note that filesafe-js is set as an \"external\" in webpack.config, so it is not included in the EditorKit bundle\n    if(supportsFilesafe) {\n      this.filesafeImportPromise = this.importFilesafe();\n    }\n  }\n\n  async importFilesafe() {\n    return import(\"filesafe-js\").then((result) => {\n      this.FilesafeClass = result.default;\n      this.configureFilesafe();\n      return this.filesafe;\n    });\n  }\n\n  async getFilesafe() {\n    if(!this.filesafe || this.filesafeImportPromise) {\n      if(this.filesafeImportPromise) {\n        return this.filesafeImportPromise;\n      }\n    } else {\n      return this.importFilesafe();\n    }\n  }\n\n  configureFilesafe() {\n    console.log(\"editor-kit | configuring filesafe\");\n    this.filesafe = new this.FilesafeClass({componentManager: this.componentManager});\n\n    this.filesafe.addDataChangeObserver(() => {\n      // Reload UI by querying Filesafe for changes\n      let allFileDescriptors = this.filesafe.getAllFileDescriptors();\n\n      if(this.note && this.fileIdsPendingAssociation.length > 0) {\n        let hasMatch = false;\n        for(let uuid of this.fileIdsPendingAssociation.slice()) {\n          let descriptor = allFileDescriptors.find((candidate) => candidate.uuid == uuid);\n          if(!descriptor) {\n            continue;\n          }\n\n          hasMatch = true;\n          // console.log(\"Attching file descriptor to note\", descriptor);\n          descriptor.addItemAsRelationship(this.note);\n          this.componentManager.saveItem(descriptor);\n          this.fileIdsPendingAssociation.splice(this.fileIdsPendingAssociation.indexOf(uuid), 1);\n\n          let syntax = FilesafeHtml.insertionSyntaxForFileDescriptor(descriptor);\n          this.delegate.insertRawText(syntax);\n        }\n\n        if(hasMatch) {\n          this.textExpander.searchPatterns()\n        }\n      }\n\n      if(allFileDescriptors.length > 0) {\n        this.fileLoader.loadFilesafeElements();\n      }\n    });\n\n    this.filesafe.addNewFileDescriptorHandler((fileDescriptor) => {\n      // Called when a new file is uploaded. We'll wait until the bridge acknowledges\n      // receipt of this item, and then it will be added to the editor.\n      // console.log(\"Adding file descriptror to association queue\", fileDescriptor.uuid);\n      this.fileIdsPendingAssociation.push(fileDescriptor.uuid);\n    })\n\n    this.fileLoader = new FileLoader({\n      filesafe: this.filesafe,\n      getElementsBySelector: this.delegate.getElementsBySelector,\n      insertElement: this.delegate.insertElement,\n      preprocessElement: this.delegate.preprocessElement\n    });\n\n    this.textExpander = new TextExpander({\n      afterExpand: () => {\n        this.fileLoader.loadFilesafeElements();\n      },\n      getCurrentLineText: this.delegate.getCurrentLineText,\n      getPreviousLineText: this.delegate.getPreviousLineText,\n      replaceText: this.delegate.replaceText,\n      patterns: [{\n        regex: FilesafeHtml.FilesafeSyntaxPattern,\n        callback: (matchedText) => {\n          return FilesafeHtml.expandedFilesafeSyntax(matchedText);\n        }\n      }]\n    });\n  }\n\n  connectToBridge() {\n    this.componentManager = new ComponentManager(null, () => {\n      // On ready and permissions authorization\n      document.documentElement.classList.add(this.componentManager.platform);\n    });\n\n    // The editor does some debouncing for us, so we'll lower the default debounce value from 250 to 150\n    this.componentManager.coallesedSavingDelay = this.coallesedSavingDelay;\n\n    this.componentManager.streamContextItem((note) => {\n      // Todo: if note has changed, release previous temp object urls\n      let itemClass = this.FilesafeClass.getSFItemClass();\n\n      let isNewNoteLoad = true;\n      if(this.note && this.note.uuid == note.uuid) {\n        isNewNoteLoad = false;\n      }\n\n      this.note = new itemClass(note);\n\n      if(this.supportsFilesafe)  {\n        this.filesafe.setCurrentNote(this.note);\n      }\n\n       // Only update UI on non-metadata updates.\n      if(note.isMetadataUpdate) { return; }\n\n      let text = note.content.text;\n\n      // Set before expanding. We want this value to always be the collapsed value\n      this.previousText = text;\n\n      if(this.supportsFilesafe) {\n        // We want to expand any filesafe syntax in the text, but only after the text has been inserted. (Will be checked on editor change callback)\n        this.needsFilesafeElementLoad = true;\n\n        text = FilesafeHtml.expandedFilesafeSyntax(text);\n      }\n\n      this.delegate.setEditorRawText(text);\n\n      if(isNewNoteLoad) {\n        this.delegate.clearUndoHistory();\n      }\n    });\n  }\n\n  onEditorKeyUp({key, isSpace, isEnter}) {\n    this.textExpander.onKeyUp({key, isSpace, isEnter});\n  }\n\n  onEditorValueChanged(text) {\n    if(this.needsFilesafeElementLoad) {\n       this.needsFilesafeElementLoad = false;\n       this.fileLoader.loadFilesafeElements();\n    }\n\n    if(this.supportsFilesafe) {\n      text = FilesafeHtml.collapseFilesafeSyntax(text);\n\n      // Change events may be triggered several times when expanding filesafe syntax.\n      // Ultimately, while the visual layer is changing a lot, the underlying text layer,\n      // after being collapsed, will not change. So we'll compare the previous html to new collapsed html before continuing\n      let sameText = this.previousText == text;\n      if(sameText) {\n        // console.log(\"Changed html is same as previous, ignoring\");\n        return;\n      }\n    }\n\n    this.previousText = text;\n\n    let note = this.note;\n    if(note) {\n      this.componentManager.saveItemWithPresave(note, () => {\n        note.content.text = text;\n        if(this.mode == 'html')  {\n          note.content.preview_plain = Util.truncateString(Util.htmlToText(text));\n        } else {\n          note.content.preview_plain = null;\n        }\n      });\n    }\n  }\n\n  async uploadJSFileObject(file) {\n    let status = this.fileLoader.insertStatusAtCursor(\"Processing file...\");\n    return this.filesafe.encryptAndUploadJavaScriptFileObject(file).then((descriptor) => {\n      this.fileLoader.removeCursorStatus(status);\n    })\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/EditorKitInternal.js","class ComponentManager {\n\n  constructor(permissions, onReady) {\n    this.sentMessages = [];\n    this.messageQueue = [];\n    this.loggingEnabled = false;\n    this.acceptsThemes = true;\n    this.activeThemes = [];\n\n    this.initialPermissions = permissions;\n    this.onReadyCallback = onReady;\n\n    this.coallesedSaving = true;\n    this.coallesedSavingDelay = 250;\n\n    this.registerMessageHandler();\n  }\n\n  registerMessageHandler() {\n    let messageHandler = (event, mobileSource) => {\n      if (this.loggingEnabled) { console.log(\"Components API Message received:\", event.data, \"mobile?\", mobileSource)}\n\n      // The first message will be the most reliable one, so we won't change it after any subsequent events,\n      // in case you receive an event from another window.\n      if(!this.origin) {\n        this.origin = event.origin;\n      }\n      this.mobileSource = mobileSource;\n      // If from mobile app, JSON needs to be used.\n      let data = mobileSource ? JSON.parse(event.data) : event.data;\n      this.handleMessage(data);\n    }\n\n    // Mobile (React Native) uses `document`, web/desktop uses `window`.addEventListener\n    // for postMessage API to work properly.\n\n    document.addEventListener(\"message\", function (event) {\n      messageHandler(event, true);\n    }, false);\n\n    window.addEventListener(\"message\", function (event) {\n      messageHandler(event, false);\n    }, false);\n  }\n\n  handleMessage(payload) {\n    if(payload.action === \"component-registered\") {\n      this.sessionKey = payload.sessionKey;\n      this.componentData = payload.componentData;\n\n      this.onReady(payload.data);\n\n      if(this.loggingEnabled) {\n        console.log(\"Component successfully registered with payload:\", payload);\n      }\n\n    } else if(payload.action === \"themes\") {\n      if(this.acceptsThemes) {\n        this.activateThemes(payload.data.themes);\n      }\n    }\n\n    else if(payload.original) {\n      // get callback from queue\n      var originalMessage = this.sentMessages.filter(function(message){\n        return message.messageId === payload.original.messageId;\n      })[0];\n\n      if(!originalMessage) {\n        // Connection must have been reset. Alert the user.\n        alert(\"This extension is attempting to communicate with Standard Notes, but an error is preventing it from doing so. Please restart this extension and try again.\")\n      }\n\n      if(originalMessage.callback) {\n        originalMessage.callback(payload.data);\n      }\n    }\n  }\n\n  onReady(data) {\n    if(this.initialPermissions && this.initialPermissions.length > 0) {\n      this.requestPermissions(this.initialPermissions);\n    }\n\n    for(var message of this.messageQueue) {\n      this.postMessage(message.action, message.data, message.callback);\n    }\n\n    this.messageQueue = [];\n    this.environment = data.environment;\n    this.platform = data.platform;\n    this.uuid = data.uuid;\n\n    if(this.loggingEnabled) { console.log(\"onReadyData\", data); }\n\n    this.activateThemes(data.activeThemeUrls || []);\n\n    if(this.onReadyCallback) {\n      this.onReadyCallback();\n    }\n  }\n\n  getSelfComponentUUID() {\n    return this.uuid;\n  }\n\n  isRunningInDesktopApplication() {\n    return this.environment === \"desktop\";\n  }\n\n  setComponentDataValueForKey(key, value) {\n    this.componentData[key] = value;\n    this.postMessage(\"set-component-data\", {componentData: this.componentData}, function(data){});\n  }\n\n  clearComponentData() {\n    this.componentData = {};\n    this.postMessage(\"set-component-data\", {componentData: this.componentData}, function(data){});\n  }\n\n  componentDataValueForKey(key) {\n    return this.componentData[key];\n  }\n\n  postMessage(action, data, callback) {\n    if(!this.sessionKey) {\n      this.messageQueue.push({\n        action: action,\n        data: data,\n        callback: callback\n      });\n      return;\n    }\n\n    var message = {\n      action: action,\n      data: data,\n      messageId: this.generateUUID(),\n      sessionKey: this.sessionKey,\n      api: \"component\"\n    }\n\n    var sentMessage = JSON.parse(JSON.stringify(message));\n    sentMessage.callback = callback;\n    this.sentMessages.push(sentMessage);\n\n    // Mobile (React Native) requires a string for the postMessage API.\n    if(this.mobileSource) {\n      message = JSON.stringify(message);\n    }\n\n    if(this.loggingEnabled) {\n      console.log(\"Posting message:\", message);\n    }\n\n    window.parent.postMessage(message, this.origin);\n  }\n\n  setSize(type, width, height) {\n    this.postMessage(\"set-size\", {type: type, width: width, height: height}, function(data){\n\n    })\n  }\n\n  requestPermissions(permissions, callback) {\n    this.postMessage(\"request-permissions\", {permissions: permissions}, function(data){\n      callback && callback();\n    }.bind(this));\n  }\n\n  streamItems(contentTypes, callback) {\n    if(!Array.isArray(contentTypes)) {\n      contentTypes = [contentTypes];\n    }\n    this.postMessage(\"stream-items\", {content_types: contentTypes}, function(data){\n      callback(data.items);\n    }.bind(this));\n  }\n\n  streamContextItem(callback) {\n    this.postMessage(\"stream-context-item\", null, (data) => {\n      var item = data.item;\n      /*\n        When an item is saved via saveItem, its updated_at value is set client side to the current date.\n        If we make a change locally, then for whatever reason receive an item via streamItems/streamContextItem,\n        we want to ignore that change if it was made prior to the latest change we've made.\n\n        Update 1/22/18: However, if a user is restoring a note from version history, this change\n        will not pass through this filter and will thus be ignored. Because the client now handles\n        this case with isMetadataUpdate, we no longer need the below.\n      */\n      // if(this.streamedContextItem && this.streamedContextItem.uuid == item.uuid\n      //   && this.streamedContextItem.updated_at > item.updated_at) {\n      //   return;\n      // }\n      // this.streamedContextItem = item;\n      callback(item);\n    });\n  }\n\n  selectItem(item) {\n    this.postMessage(\"select-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  createItem(item, callback) {\n    this.postMessage(\"create-item\", {item: this.jsonObjectForItem(item)}, function(data){\n      var item = data.item;\n\n      // A previous version of the SN app had an issue where the item in the reply to create-item\n      // would be nested inside \"items\" and not \"item\". So handle both cases here.\n      if(!item && data.items && data.items.length > 0) {\n        item = data.items[0];\n      }\n\n      this.associateItem(item);\n      callback && callback(item);\n    }.bind(this));\n  }\n\n  createItems(items, callback) {\n    let mapped = items.map((item) => {return this.jsonObjectForItem(item)});\n    this.postMessage(\"create-items\", {items: mapped}, function(data){\n      callback && callback(data.items);\n    }.bind(this));\n  }\n\n  associateItem(item) {\n    this.postMessage(\"associate-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  deassociateItem(item) {\n    this.postMessage(\"deassociate-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  clearSelection() {\n    this.postMessage(\"clear-selection\", {content_type: \"Tag\"});\n  }\n\n  deleteItem(item, callback) {\n    this.deleteItems([item], callback);\n  }\n\n  deleteItems(items, callback) {\n    var params = {\n      items: items.map(function(item){\n        return this.jsonObjectForItem(item);\n      }.bind(this))\n    };\n\n    this.postMessage(\"delete-items\", params, (data) => {\n      callback && callback(data);\n    });\n  }\n\n  sendCustomEvent(action, data, callback) {\n    this.postMessage(action, data, function(data){\n      callback && callback(data);\n    }.bind(this));\n  }\n\n  saveItem(item, callback, skipDebouncer = false) {\n    this.saveItems([item], callback, skipDebouncer);\n  }\n\n  /* Presave allows clients to perform any actions last second before the save actually occurs (like setting previews).\n     Saves debounce by default, so if a client needs to compute a property on an item before saving, it's best to\n     hook into the debounce cycle so that clients don't have to implement their own debouncing.\n   */\n\n  saveItemWithPresave(item, presave, callback) {\n    this.saveItemsWithPresave([item], presave, callback);\n  }\n\n  saveItemsWithPresave(items, presave, callback) {\n    this.saveItems(items, callback, false, presave);\n  }\n\n  /*\n  skipDebouncer allows saves to go through right away rather than waiting for timeout.\n  This should be used when saving items via other means besides keystrokes.\n   */\n  saveItems(items, callback, skipDebouncer = false, presave) {\n    let saveBlock = (itemsToSave) => {\n      // presave block allows client to gain the benefit of performing something in the debounce cycle.\n      presave && presave();\n\n      let mappedUuids = [];\n      let mappedItems = [];\n      for(let item of itemsToSave) {\n        // To prevent duplicates\n        if(mappedUuids.includes(item.uuid)) {\n          continue;\n        }\n\n        mappedUuids.push(item.uuid);\n        item.updated_at = new Date();\n        mappedItems.push(this.jsonObjectForItem(item));\n      }\n\n      this.postMessage(\"save-items\", {items: mappedItems}, (data) => {\n        callback && callback();\n      });\n    }\n\n    /*\n      Coallesed saving prevents saves from being made after every keystroke, and instead\n      waits coallesedSavingDelay before performing action. For example, if a user types a keystroke, and the clienet calls saveItem,\n      a 250ms delay will begin. If they type another keystroke within 250ms, the previously pending\n      save will be cancelled, and another 250ms delay occurs. If ater 250ms the pending delay is not cleared by a future call,\n      the save will finally trigger.\n\n      Note: it's important to modify saving items updated_at immediately and not after delay. If you modify after delay,\n      a delayed sync could just be wrapping up, and will send back old data and replace what the user has typed.\n\n    */\n\n    // We also need to make sure that when we clear a pending save timeout, we carry over those pending items into the new save.\n    if(!this.pendingSaveItems) { this.pendingSaveItems = [];}\n\n    if(this.coallesedSaving == true && !skipDebouncer) {\n      if(this.pendingSave) {\n        clearTimeout(this.pendingSave);\n      }\n\n      this.pendingSaveItems = this.pendingSaveItems.concat(items);\n      this.pendingSave = setTimeout(() => {\n        saveBlock(this.pendingSaveItems);\n        // Clear pending save items\n        this.pendingSaveItems = [];\n      }, this.coallesedSavingDelay);\n    } else {\n      saveBlock(items);\n    }\n  }\n\n  jsonObjectForItem(item) {\n    var copy = Object.assign({}, item);\n    copy.children = null;\n    copy.parent = null;\n    return copy;\n  }\n\n  getItemAppDataValue(item, key) {\n    let AppDomain = \"org.standardnotes.sn\";\n    var data = item.content.appData && item.content.appData[AppDomain];\n    if(data) {\n      return data[key];\n    } else {\n      return null;\n    }\n  }\n\n  /* Themes */\n\n  activateThemes(incomingUrls) {\n    if(this.loggingEnabled) { console.log(\"Incoming themes\", incomingUrls); }\n    if(this.activeThemes.sort().toString() == incomingUrls.sort().toString()) {\n      // incoming are same as active, do nothing\n      return;\n    }\n\n    let themesToActivate = incomingUrls || [];\n    let themesToDeactivate = [];\n\n    for(var activeUrl of this.activeThemes) {\n      if(!incomingUrls.includes(activeUrl)) {\n        // active not present in incoming, deactivate it\n        themesToDeactivate.push(activeUrl);\n      } else {\n        // already present in active themes, remove it from themesToActivate\n        themesToActivate = themesToActivate.filter((candidate) => {\n          return candidate != activeUrl;\n        })\n      }\n    }\n\n    if(this.loggingEnabled) {\n      console.log(\"Deactivating themes:\", themesToDeactivate);\n      console.log(\"Activating themes:\", themesToActivate);\n    }\n\n    for(var theme of themesToDeactivate) {\n      this.deactivateTheme(theme);\n    }\n\n    this.activeThemes = incomingUrls;\n\n    for(var url of themesToActivate) {\n      if(!url) {\n        continue;\n      }\n\n      var link = document.createElement(\"link\");\n      link.id = btoa(url);\n      link.href = url;\n      link.type = \"text/css\";\n      link.rel = \"stylesheet\";\n      link.media = \"screen,print\";\n      link.className = \"custom-theme\";\n      document.getElementsByTagName(\"head\")[0].appendChild(link);\n    }\n  }\n\n  themeElementForUrl(url) {\n    var elements = Array.from(document.getElementsByClassName(\"custom-theme\")).slice();\n    return elements.find((element) => {\n      // We used to search here by `href`, but on desktop, with local file:// urls, that didn't work for some reason.\n      return element.id == btoa(url);\n    })\n  }\n\n  deactivateTheme(url) {\n    let element = this.themeElementForUrl(url);\n    if(element) {\n      element.disabled = true;\n      element.parentNode.removeChild(element);\n    }\n  }\n\n  /* Theme caching is currently disabled. Might be enabled in the future if neccessary. */\n  /*\n  activateCachedThemes() {\n    let themes = this.getCachedThemeUrls();\n    let writeToCache = false;\n    if(this.loggingEnabled) { console.log(\"Activating cached themes\", themes); }\n    this.activateThemes(themes, writeToCache);\n  }\n\n  cacheThemeUrls(urls) {\n    if(this.loggingEnabled) { console.log(\"Caching theme urls\", urls); }\n    localStorage.setItem(\"cachedThemeUrls\", JSON.stringify(urls));\n  }\n\n  decacheThemeUrls() {\n    localStorage.removeItem(\"cachedThemeUrls\");\n  }\n\n  getCachedThemeUrls() {\n    let urls = localStorage.getItem(\"cachedThemeUrls\");\n    if(urls) {\n      return JSON.parse(urls);\n    } else {\n      return [];\n    }\n  }\n  */\n\n\n  /* Utilities */\n\n\n  generateUUID() {\n    var crypto = window.crypto || window.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(window.performance && typeof window.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n}\n\n\nif(typeof module != \"undefined\" && typeof module.exports != \"undefined\") {\n  module.exports = ComponentManager;\n}\n\nif(window) {\n  window.ComponentManager = ComponentManager;\n}\n\n\n\n// WEBPACK FOOTER //\n// ../src/componentManager.js","import Util from \"./Util.js\";\n\nexport default class FileLoader {\n\n  constructor({filesafe, getElementsBySelector, preprocessElement, insertElement}) {\n    this.filesafe = filesafe;\n    this.getElementsBySelector = getElementsBySelector;\n    this.insertElement = insertElement;\n    this.preprocessElement = preprocessElement;\n\n    // When a file is decrypted and loaded into a temp url, we'll place the temp url in here so that subsequent decrypt attempts\n    // dont require further work. Mapped values are of form {url, fileType, fsname}\n    this.uuidToFileTempUrlAndTypeMapping = {};\n\n    // uuids of files currently loading, so that we don't start a new load for currently loading file\n    this.currentlyLoadingIds = [];\n\n    // uuid to current status element mapping\n    this.statusElementMapping = {};\n\n    this.fileTypeToElementType = {\n      \"image/png\": \"img\",\n      \"image/jpg\": \"img\",\n      \"image/jpeg\": \"img\",\n      \"image/gif\": \"img\",\n      \"image/tiff\": \"img\",\n      \"image/bmp\": \"img\",\n      \"video/mp4\": \"video\",\n      \"audio/mpeg\": \"audio\",\n      \"audio/mp3\": \"audio\"\n    }\n  }\n\n  fileTypeForElementType(type) {\n    return this.fileTypeToElementType[type.toLowerCase()];\n  }\n\n  /*\n    Scans the document for elements <filesafe>. If found, begins loading file.\n  */\n  loadFilesafeElements() {\n    let elements = this.getElementsBySelector(\"*[fsplaceholder]\");\n    for(let element of elements) {\n      this.loadFilesafeElement(element);\n    }\n  }\n\n  /*\n  @param fsSyntax\n  The FileSafe syntax string. i.e [FileSafe:uuid-123:name]\n  */\n\n  async loadFilesafeElement(fsElement) {\n    let fsid = fsElement.getAttribute(\"fsid\");\n    let fsname = fsElement.getAttribute(\"fsname\");\n\n    let existingMapping = this.uuidToFileTempUrlAndTypeMapping[fsid];\n    if(existingMapping) {\n      this.insertMediaElement({url: existingMapping.url, fsid,\n        fileType: existingMapping.fileType, fsname: existingMapping.fsname, fsElement});\n      return;\n    }\n\n    if(this.currentlyLoadingIds.includes(fsid)) {\n      return;\n    }\n\n    let descriptor = this.filesafe.findFileDescriptor(fsid);\n    if(!descriptor) {\n      this.setStatus(\"Unable to find file.\", fsElement, fsid);\n      console.log(\"Can't find descriptor with id\", fsid);\n      return {success: false};\n    }\n\n    let selectorSyntax = `[fsid=\"${descriptor.uuid}\"][fscollapsable]`;\n    var existingElements = document.querySelectorAll(`img${selectorSyntax}, figure${selectorSyntax}, video${selectorSyntax}, audio${selectorSyntax}`);\n    if(existingElements.length > 0) {\n      console.log(\"File already exists\");\n      return {success: false};\n    }\n\n    const cleanup = () => {\n      this.currentlyLoadingIds.splice(this.currentlyLoadingIds.indexOf(fsid), 1);\n    }\n\n    this.currentlyLoadingIds.push(fsid);\n\n    this.setStatus(\"Downloading file...\", fsElement, fsid);\n    await Util.sleep(0.05); // Allow UI to update before beginning download\n    let fileItem = await this.filesafe.downloadFileFromDescriptor(descriptor).catch((downloadError) => {\n      this.setStatus(\"Unable to download file.\", fsElement, fsid);\n      return;\n    })\n\n    if(!fileItem) {\n      return;\n    }\n\n    this.setStatus(\"Decrypting file...\", fsElement, fsid);\n    await Util.sleep(0.05); // Allow UI to update before beginning decryption\n    let data = await this.filesafe.decryptFile({fileDescriptor: descriptor, fileItem: fileItem}).catch((decryptError) => {\n      this.setStatus(\"Unable to decrypt file.\", fsElement, fsid);\n      return;\n    });\n\n    if(!data) {\n      return;\n    }\n\n    // Remove loading text\n    this.setStatus(null, fsElement, fsid);\n    await Util.sleep(0.05); // Allow UI to update before adding image\n\n    // Generate temporary url, must be released later\n    let fileType = descriptor.content.fileType;\n    let tempUrl = this.filesafe.createTemporaryFileUrl({base64Data: data.decryptedData, dataType: fileType});\n\n    this.insertMediaElement({url: tempUrl, fsid, fileType, fsname, fsElement});\n\n    cleanup();\n\n    this.uuidToFileTempUrlAndTypeMapping[fsid] = {url: tempUrl, fileType, fsname: fsname};\n\n    return {success: true};\n  }\n\n  insertMediaElement({url, fsid, fsname, fileType, fsElement}) {\n    let elementType = this.fileTypeForElementType(fileType);\n\n    let mediaElement;\n    if(elementType == \"img\") {\n      mediaElement = this.createImageElement({url, fsid, fsname, fsElement});\n    } else if(elementType == \"video\") {\n      mediaElement = this.createVideoElement({url, fsid, fileType, fsname, fsElement});\n    } else if(elementType == \"audio\") {\n      mediaElement = this.createAudioElement({url, fsid, fsname});\n    } else {\n      // File not supported\n      this.setStatus(\"File not supported.\", fsElement, fsid);\n      return false;\n    }\n\n    this.insertElementAdjacent(mediaElement, fsElement);\n\n    // Remove fsElement now that image is loaded\n    fsElement.remove();\n\n    return true;\n  }\n\n  /*\n    The below applies to img tags, but not video and audio tags. So we use this for video and audio elements only.\n    Redactor automatically includes figure elements for image, as part of this.preprocessElement\n    We'd like to wrap it in a figure ideally, but right now there is a bug where inserting\n    the figure element programatically, then entering to create new line after the figure,\n    inserts the paragraph text inside the figure element. We ignore this figure element\n    on saving to SN, so this text would be lost.\n   */\n  wrapElementInFigure({element, fsid, fsname}) {\n    let figure = document.createElement('figure');\n    figure.setAttribute('fsid', fsid);\n    figure.setAttribute('fsname', fsname);\n    figure.setAttribute('fscollapsable', true);\n    figure.append(element);\n    return figure;\n  }\n\n  createImageElement({url, fsid, fsname, fsElement}) {\n    let image = document.createElement(\"img\");\n    image.setAttribute('src', url);\n    image.setAttribute('srcset', `${url} 2x`);\n\n    image.setAttribute('fsid', fsid);\n    image.setAttribute('fsname', fsname);\n    image.setAttribute('fscollapsable', true);\n\n    if(fsElement.getAttribute(\"width\")) {\n      image.setAttribute(\"width\", fsElement.getAttribute(\"width\"));\n      image.setAttribute(\"height\", fsElement.getAttribute(\"height\"));\n    }\n\n    return image;\n  }\n\n  createVideoElement({url, fsid, fileType, fsname, fsElement}) {\n    let video = document.createElement(\"video\");\n    video.setAttribute('controls', true);\n    video.setAttribute('fsid', fsid);\n    video.setAttribute('fsname', fsname);\n    video.setAttribute('fscollapsable', true);\n\n    if(fsElement.getAttribute(\"width\")) {\n      video.setAttribute(\"width\", fsElement.getAttribute(\"width\"));\n      video.setAttribute(\"height\", fsElement.getAttribute(\"height\"));\n    }\n\n    let source = document.createElement(\"source\");\n    source.setAttribute('src', url);\n    source.setAttribute('type', fileType);\n\n    video.append(source);\n    return this.wrapElementInFigure({element: video, fsid, fsname});\n  }\n\n  createAudioElement({url, fsid, fsname}) {\n    let audio = document.createElement(\"audio\");\n    audio.setAttribute('src', url);\n    audio.setAttribute('controls', true);\n    audio.setAttribute('fsid', fsid);\n    audio.setAttribute('fsname', fsname);\n    audio.setAttribute('fscollapsable', true);\n\n    return this.wrapElementInFigure({element: audio, fsid, fsname});;\n  }\n\n  setStatus(status, fsElement, fsid) {\n    if(fsid) {\n      let existingStatusElement = this.statusElementMapping[fsid];\n      if(existingStatusElement) {\n        existingStatusElement.remove();\n        delete this.statusElementMapping[fsid];\n      }\n    }\n\n    if(status) {\n      let element = document.createElement('span');\n      element.setAttribute('id', fsid);\n      element.setAttribute('ghost', 'true');\n      element.setAttribute('contenteditable', false);\n      element.setAttribute('style', 'font-weight: bold');\n      element.textContent = status;\n      element = this.insertElementAdjacent(element, fsElement);\n      if(fsid) {\n        this.statusElementMapping[fsid] = element;\n      }\n      return element;\n    }\n  }\n\n  insertStatusAtCursor(status) {\n    let identifier = Math.random().toString(36).substring(7);\n    this.setStatus(status, null, identifier);\n    return identifier;\n  }\n\n  removeCursorStatus(identifier) {\n    // We want to search for the element based on identifier, because the actual element\n    // inserted may have been done so as raw HTML, and not via an element pointer\n    let elements = this.getElementsBySelector(`#${identifier}`);\n    if(elements.length > 0) {\n      elements[0].remove();\n    }\n  }\n\n  insertElementAdjacent(domNodeToInsert, adjacentToElement) {\n    let processedElement = this.preprocessElement(domNodeToInsert);\n    this.insertElement(processedElement, adjacentToElement);\n    return processedElement;\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/FileLoader.js","export default class TextExpander {\n\n  constructor({patterns, afterExpand, beforeExpand, getCurrentLineText, getPreviousLineText, replaceText}) {\n    this.patterns = patterns;\n    this.afterExpand = afterExpand;\n    this.beforeExpand = beforeExpand;\n    this.getCurrentLineText = getCurrentLineText;\n    this.getPreviousLineText = getPreviousLineText;\n    this.replaceText = replaceText;\n  }\n\n  onKeyUp({key, isSpace, isEnter}) {\n    if(isSpace || isEnter) {\n      this.searchPatterns({searchPreviousLine: isEnter});\n    }\n  }\n\n  searchPatterns({searchPreviousLine} = {}) {\n    let text;\n    if(searchPreviousLine) {\n      text = this.getPreviousLineText();\n    } else {\n      text = this.getCurrentLineText();\n    }\n\n    for (let pattern of this.patterns) {\n      const match = pattern.regex.exec(text);\n      if(!match) { continue; }\n      const matchedText = match[0];\n      if(matchedText) {\n        let replaceWith = pattern.callback(matchedText);\n        this.replaceSelection(pattern.regex, replaceWith, searchPreviousLine);\n      }\n    }\n  }\n\n  replaceSelection(regex, replacement, previousLine) {\n    if(this.beforeExpand) {\n      this.beforeExpand();\n    }\n\n    this.replaceText({regex, replacement, previousLine});\n\n    if(this.afterExpand) {\n      this.afterExpand();\n    }\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/TextExpander.js","export default class FilesafeHtml {\n\n  // Remove matching <p> tags if present\n  static FilesafeSyntaxPattern = /(<p>)?\\[FileSafe.*\\](<\\/p>)?/g;\n\n  /*\n  Given an HTML string that includes substrings matching `FilesafeSyntaxPattern`,\n  replace occurences with ghost div element <filesafe uuid='123'>\n  */\n  static expandedFilesafeSyntax(html) {\n    let result = html.replace(this.FilesafeSyntaxPattern, (match) => {\n      return this.filesafeSyntaxToHtmlElement(match);\n    })\n\n    return result;\n  }\n\n  static insertionSyntaxForFileDescriptor(descriptor) {\n    return `[FileSafe:${descriptor.uuid}:${descriptor.content.fileName}]`;\n  }\n\n  static filesafeSyntaxToHtmlElement(syntax) {\n    // remove paragraph tags\n    syntax = syntax.replace(\"<p>\", \"\");\n    syntax = syntax.replace(\"</p>\", \"\");\n    // Remove brackets\n    syntax = syntax.replace(\"[\", \"\").replace(\"]\", \"\");\n    let components = syntax.split(\":\");\n    let uuid = components[1];\n    let name = components[2];\n    let size = components[3];\n    let sizeString = \"\";\n    if(size)  {\n      let dimensions = size.split(\"x\");\n      sizeString = `width=${dimensions[0]} height=${dimensions[1]}`\n    }\n    // We use a p tag here because if try something custom, like `filesafe` tag, the editor will automatically\n    // wrap it in a p tag, causing littered p tags remaining in the plaintext representation.\n    let result = `<span fsplaceholder=true style='display: none;' fscollapsable=true ghost=true fsid=${uuid} fsname=${name} ${sizeString}></span>`;\n    return result;\n  }\n\n  /*\n    Given a rendered HTML string, replace all <filesafe> items with [FileSafe:UUID] plaintext items.\n    Also, for any elements that have the 'ghost' attribute, remove it from the resulting string\n  */\n  static collapseFilesafeSyntax(html) {\n    let domCopy = new DOMParser().parseFromString(html, \"text/html\");\n    // Elements that have fscollapsable means they should be collapsed to plain syntax\n    let mediaElements = domCopy.querySelectorAll(`*[fscollapsable]`);\n\n    /*\n     Some editors (Redactor) may arbitrarily wrap elements inside a <p> tag before inserting into dom\n     Then, when we collapse all the elements, and when the ghosts are removed, we find an emtpy <p> tag\n     just sitting around. We want to find these candidates by scanning for all p tags, checking to see how many ghosts it has,\n     and if the number of ghosts matches its number of children, we know that after everything is collapsed, this p tag will most\n     likely be empty. However, if we replace an element with its collapsed syntax, it will not be empty.\n     So items placed in pTagsToRemoveCandidates are just candidates. We'll check again after we do all collapsing\n     and ghost removing, and if it has 0 children and its innerHTML length == 0, we'll remove it\n    */\n    let pTags = domCopy.querySelectorAll(`p`);\n    let pTagsToRemoveCandidates = [];\n\n    for(let pTag of pTags) {\n      let numGhosts = pTag.querySelectorAll(\"[ghost]\").length;\n      let numChildren = pTag.children.length;\n      if(numChildren == numGhosts)  {\n        pTagsToRemoveCandidates.push(pTag);\n      }\n    }\n\n    for(let file of mediaElements) {\n      let uuid = file.getAttribute('fsid');\n      let name = file.getAttribute('fsname');\n      let width = file.getAttribute('width');\n      let height = file.getAttribute('height');\n\n      let components = [\"FileSafe\", uuid, name];\n      if(width || height) {\n        let size = `${width}x${height}`;\n        components.push(size);\n      }\n\n      let fsSyntax = `[${components.join(\":\")}]`;\n      file.insertAdjacentText('afterend', fsSyntax);\n      file.remove();\n    }\n\n    let ghosts = domCopy.querySelectorAll(`*[ghost]`);\n    ghosts.forEach((ghost) => {ghost.remove()});\n    pTagsToRemoveCandidates.forEach((pTag) => {\n      // Make sure children count is still 0\n      if(pTag.children.length == 0 && pTag.innerHTML.trim().length == 0) {\n        pTag.remove()\n      }\n    });\n\n    let result = domCopy.body.innerHTML;\n    return result;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/FilesafeHtml.js","module.exports = require(\"filesafe-js\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"filesafe-js\"\n// module id = 7\n// module chunks = 0 1","/*\n  The delegate is responsible for responding to events and functions\n  that the EditorKit requires. For example, when EditorKit wants to insert\n  a new HTML element, it won't neccessarily know how, because it's not designed for\n  any particular editor. Instead, it will tell the delegate to insert the element.\n\n  The consumer of this API, the actual editor, would configure this delegate with\n  the appropriate callbacks.\n\n  Callbacks are defined in the constructor.\n*/\n\nexport default class EditorKitDelegate {\n\n  constructor({insertRawText, onReceiveNote,\n    setEditorRawText, getCurrentLineText, getPreviousLineText, replaceText,\n    getElementsBySelector, insertElement, preprocessElement, clearUndoHistory}) {\n    this.insertRawText = insertRawText;\n    this.onReceiveNote = onReceiveNote;\n    this.setEditorRawText = setEditorRawText;\n    this.getCurrentLineText = getCurrentLineText;\n    this.getPreviousLineText = getPreviousLineText;\n    this.replaceText = replaceText;\n    this.getElementsBySelector = getElementsBySelector;\n    this.insertElement = insertElement;\n    this.preprocessElement = preprocessElement;\n    this.clearUndoHistory = clearUndoHistory;\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/EditorKitDelegate.js"],"sourceRoot":""}