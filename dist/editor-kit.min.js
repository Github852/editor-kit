module.exports=function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}n.d(t,"a",function(){return s});var s=function(){function e(){i(this,e)}return a(e,null,[{key:"htmlToText",value:function(e){var t=document.implementation.createHTMLDocument("New").body;return t.innerHTML=e,t.textContent||t.innerText||""}},{key:"truncateString",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:90;return e.length<=t?e:e.substring(0,t)+"..."}},{key:"sleep",value:function(e){return new Promise(function(t,n){setTimeout(function(){t()},1e3*e)})}}]),e}()},function(e,t,n){"use strict";function i(e,t,n,i,r,a,s){try{var o=e[a](s),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){function s(e){i(l,r,a,s,o,"next",e)}function o(e){i(l,r,a,s,o,"throw",e)}var l=e.apply(t,n);s(void 0)})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"EditorKit",function(){return c});var l=n(2),u=n(8);n.d(t,"EditorKitDelegate",function(){return u.a});var c=function(){function e(t){var n=t.delegate,i=t.mode,r=void 0===i?"plaintext":i,s=t.supportsFilesafe,o=void 0!==s&&s,u=t.coallesedSavingDelay,c=void 0===u?250:u;a(this,e),this.delegate=n,this.mode=r,this.supportsFilesafe=o,this.coallesedSavingDelay=c,this.internal=new l.a({delegate:n,mode:r,supportsFilesafe:o,coallesedSavingDelay:c})}return o(e,[{key:"getFilesafe",value:function(){function e(){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.internal.getFilesafe());case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"onEditorValueChanged",value:function(e){this.internal.onEditorValueChanged(e)}},{key:"onEditorKeyUp",value:function(e){var t=e.key,n=e.isSpace,i=e.isEnter;this.internal.onEditorKeyUp({key:t,isSpace:n,isEnter:i})}},{key:"canUploadFiles",value:function(){return this.internal.canUploadFiles()}},{key:"uploadJSFileObject",value:function(){function e(e){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.internal.uploadJSFileObject(t));case 1:case"end":return e.stop()}},e,this)}));return e}()}]),e}()},function(e,t,n){"use strict";function i(e,t,n,i,r,a,s){try{var o=e[a](s),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){function s(e){i(l,r,a,s,o,"next",e)}function o(e){i(l,r,a,s,o,"throw",e)}var l=e.apply(t,n);s(void 0)})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}n.d(t,"a",function(){return h});var l=n(3),u=n.n(l),c=n(0),f=n(4),m=n(5),d=n(6),h=function(){function e(t){var n=t.delegate,i=t.mode,r=t.supportsFilesafe,s=t.coallesedSavingDelay,o=void 0===s?250:s;a(this,e),this.delegate=n,this.mode=i,this.supportsFilesafe=r,this.coallesedSavingDelay=o,this.fileIdsPendingAssociation=[],this.connectToBridge(),r&&(this.filesafeImportPromise=this.importFilesafe())}return o(e,[{key:"importFilesafe",value:function(){function e(){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){e()}).then(n.bind(null,7)).then(function(e){return t.FilesafeClass=e.default,t.configureFilesafe(),t.filesafe}));case 1:case"end":return e.stop()}},e)}));return e}()},{key:"getFilesafe",value:function(){function e(){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.filesafe&&!this.filesafeImportPromise){e.next=5;break}if(!this.filesafeImportPromise){e.next=3;break}return e.abrupt("return",this.filesafeImportPromise);case 3:e.next=6;break;case 5:return e.abrupt("return",this.importFilesafe());case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"configureFilesafe",value:function(){var e=this;this.filesafe=new this.FilesafeClass({componentManager:this.componentManager}),this.filesafe.addDataChangeObserver(function(){var t=e.filesafe.getAllFileDescriptors();if(e.note&&e.fileIdsPendingAssociation.length>0){var n=!1,i=!0,r=!1,a=void 0;try{for(var s,o=e.fileIdsPendingAssociation.slice()[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){(function(){var i=s.value,r=t.find(function(e){return e.uuid==i});if(!r)return"continue";n=!0,r.addItemAsRelationship(e.note),e.componentManager.saveItem(r),e.fileIdsPendingAssociation.splice(e.fileIdsPendingAssociation.indexOf(i),1);var a=d.a.insertionSyntaxForFileDescriptor(r);e.delegate.insertRawText(a)})()}}catch(e){r=!0,a=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}n&&e.textExpander.searchPatterns()}t.length>0&&setTimeout(function(){e.fileLoader.loadFilesafeElements()},5e3)}),this.filesafe.addNewFileDescriptorHandler(function(t){e.fileIdsPendingAssociation.push(t.uuid)}),this.fileLoader=new f.a({filesafe:this.filesafe,getElementsBySelector:this.delegate.getElementsBySelector,insertElement:this.delegate.insertElement,preprocessElement:this.delegate.preprocessElement}),this.textExpander=new m.a({afterExpand:function(){e.fileLoader.loadFilesafeElements()},getCurrentLineText:this.delegate.getCurrentLineText,getPreviousLineText:this.delegate.getPreviousLineText,replaceText:this.delegate.replaceText,patterns:[{regex:d.a.FilesafeSyntaxPattern,callback:function(e){return d.a.expandedFilesafeSyntax(e)}}]})}},{key:"connectToBridge",value:function(){var e=this;this.componentManager=new u.a(null,function(){document.documentElement.classList.add(e.componentManager.platform)}),this.componentManager.coallesedSavingDelay=this.coallesedSavingDelay,this.componentManager.streamContextItem(function(t){var n=e.FilesafeClass.getSFItemClass(),i=!0;if(e.note&&e.note.uuid==t.uuid&&(i=!1),e.note=new n(t),e.supportsFilesafe&&e.filesafe.setCurrentNote(e.note),!t.isMetadataUpdate){var r=t.content.text;if("html"==e.mode&&i){/<[a-z][\s\S]*>/i.test(r)||(e.ignoreNextTextChange=!0)}e.previousText=r,e.supportsFilesafe&&(e.needsFilesafeElementLoad=!0,r=d.a.expandedFilesafeSyntax(r)),e.delegate.setEditorRawText(r),i&&e.delegate.clearUndoHistory()}})}},{key:"onEditorKeyUp",value:function(e){var t=e.key,n=e.isSpace,i=e.isEnter;this.textExpander.onKeyUp({key:t,isSpace:n,isEnter:i})}},{key:"onEditorValueChanged",value:function(e){var t=this;if(this.needsFilesafeElementLoad&&(this.needsFilesafeElementLoad=!1,this.fileLoader.loadFilesafeElements()),this.ignoreNextTextChange)return void(this.ignoreNextTextChange=!1);if(this.supportsFilesafe){e=d.a.collapseFilesafeSyntax(e);if(this.previousText==e)return}this.previousText=e;var n=this.note;n&&this.componentManager.saveItemWithPresave(n,function(){if(n.content.text=e,"html"==t.mode){var i=d.a.removeFilesafeSyntaxFromHtml(e);i=c.a.truncateString(c.a.htmlToText(i)),n.content.preview_plain=i}else n.content.preview_plain=null})}},{key:"canUploadFiles",value:function(){var e=this.filesafe.getAllCredentials(),t=this.filesafe.getAllIntegrations();return e.length>0&&t.length>0}},{key:"uploadJSFileObject",value:function(){function e(e){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(t){var n,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.fileLoader.insertStatusAtCursor("Processing file..."),e.abrupt("return",this.filesafe.encryptAndUploadJavaScriptFileObject(t).then(function(e){i.fileLoader.removeCursorStatus(n)}));case 2:case"end":return e.stop()}},e,this)}));return e}()}]),e}()},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=function(){function e(t,n){i(this,e),this.sentMessages=[],this.messageQueue=[],this.loggingEnabled=!1,this.acceptsThemes=!0,this.activeThemes=[],this.initialPermissions=t,this.onReadyCallback=n,this.coallesedSaving=!0,this.coallesedSavingDelay=250,this.registerMessageHandler()}return r(e,[{key:"registerMessageHandler",value:function(){var e=this,t=function(t){e.loggingEnabled&&console.log("Components API Message received:",t.data),e.origin||(e.origin=t.origin);var n=t.data,i="string"==typeof n?JSON.parse(n):n;e.handleMessage(i)};document.addEventListener("message",function(e){t(e)},!1),window.addEventListener("message",function(e){t(e)},!1)}},{key:"handleMessage",value:function(e){if("component-registered"===e.action)this.sessionKey=e.sessionKey,this.componentData=e.componentData,this.onReady(e.data),this.loggingEnabled&&console.log("Component successfully registered with payload:",e);else if("themes"===e.action)this.acceptsThemes&&this.activateThemes(e.data.themes);else if(e.original){var t=this.sentMessages.filter(function(t){return t.messageId===e.original.messageId})[0];t||alert("This extension is attempting to communicate with Standard Notes, but an error is preventing it from doing so. Please restart this extension and try again."),t.callback&&t.callback(e.data)}}},{key:"onReady",value:function(e){this.environment=e.environment,this.platform=e.platform,this.uuid=e.uuid,this.isMobile="mobile"==this.environment,this.initialPermissions&&this.initialPermissions.length>0&&this.requestPermissions(this.initialPermissions);var t=!0,n=!1,i=void 0;try{for(var r,a=this.messageQueue[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;this.postMessage(s.action,s.data,s.callback)}}catch(e){n=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw i}}this.messageQueue=[],this.loggingEnabled&&console.log("onReadyData",e),this.activateThemes(e.activeThemeUrls||[]),this.onReadyCallback&&this.onReadyCallback()}},{key:"getSelfComponentUUID",value:function(){return this.uuid}},{key:"isRunningInDesktopApplication",value:function(){return"desktop"===this.environment}},{key:"setComponentDataValueForKey",value:function(e,t){this.componentData[e]=t,this.postMessage("set-component-data",{componentData:this.componentData},function(e){})}},{key:"clearComponentData",value:function(){this.componentData={},this.postMessage("set-component-data",{componentData:this.componentData},function(e){})}},{key:"componentDataValueForKey",value:function(e){return this.componentData[e]}},{key:"postMessage",value:function(e,t,n){if(!this.sessionKey)return void this.messageQueue.push({action:e,data:t,callback:n});var i={action:e,data:t,messageId:this.generateUUID(),sessionKey:this.sessionKey,api:"component"},r=JSON.parse(JSON.stringify(i));r.callback=n,this.sentMessages.push(r),this.isMobile&&(i=JSON.stringify(i)),this.loggingEnabled&&console.log("Posting message:",i),window.parent.postMessage(i,this.origin)}},{key:"setSize",value:function(e,t,n){this.postMessage("set-size",{type:e,width:t,height:n},function(e){})}},{key:"requestPermissions",value:function(e,t){this.postMessage("request-permissions",{permissions:e},function(e){t&&t()}.bind(this))}},{key:"streamItems",value:function(e,t){Array.isArray(e)||(e=[e]),this.postMessage("stream-items",{content_types:e},function(e){t(e.items)}.bind(this))}},{key:"streamContextItem",value:function(e){this.postMessage("stream-context-item",null,function(t){var n=t.item;e(n)})}},{key:"selectItem",value:function(e){this.postMessage("select-item",{item:this.jsonObjectForItem(e)})}},{key:"createItem",value:function(e,t){this.postMessage("create-item",{item:this.jsonObjectForItem(e)},function(e){var n=e.item;!n&&e.items&&e.items.length>0&&(n=e.items[0]),this.associateItem(n),t&&t(n)}.bind(this))}},{key:"createItems",value:function(e,t){var n=this,i=e.map(function(e){return n.jsonObjectForItem(e)});this.postMessage("create-items",{items:i},function(e){t&&t(e.items)}.bind(this))}},{key:"associateItem",value:function(e){this.postMessage("associate-item",{item:this.jsonObjectForItem(e)})}},{key:"deassociateItem",value:function(e){this.postMessage("deassociate-item",{item:this.jsonObjectForItem(e)})}},{key:"clearSelection",value:function(){this.postMessage("clear-selection",{content_type:"Tag"})}},{key:"deleteItem",value:function(e,t){this.deleteItems([e],t)}},{key:"deleteItems",value:function(e,t){var n={items:e.map(function(e){return this.jsonObjectForItem(e)}.bind(this))};this.postMessage("delete-items",n,function(e){t&&t(e)})}},{key:"sendCustomEvent",value:function(e,t,n){this.postMessage(e,t,function(e){n&&n(e)}.bind(this))}},{key:"saveItem",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.saveItems([e],t,n)}},{key:"saveItemWithPresave",value:function(e,t,n){this.saveItemsWithPresave([e],t,n)}},{key:"saveItemsWithPresave",value:function(e,t,n){this.saveItems(e,n,!1,t)}},{key:"saveItems",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments[3],a=function(e){r&&r();var i=[],a=[],s=!0,o=!1,l=void 0;try{for(var u,c=e[Symbol.iterator]();!(s=(u=c.next()).done);s=!0){var f=u.value;i.includes(f.uuid)||(i.push(f.uuid),f.updated_at=new Date,a.push(n.jsonObjectForItem(f)))}}catch(e){o=!0,l=e}finally{try{!s&&c.return&&c.return()}finally{if(o)throw l}}n.postMessage("save-items",{items:a},function(e){t&&t()})};this.pendingSaveItems||(this.pendingSaveItems=[]),1!=this.coallesedSaving||i?a(e):(this.pendingSave&&clearTimeout(this.pendingSave),this.pendingSaveItems=this.pendingSaveItems.concat(e),this.pendingSave=setTimeout(function(){a(n.pendingSaveItems),n.pendingSaveItems=[]},this.coallesedSavingDelay))}},{key:"jsonObjectForItem",value:function(e){var t=Object.assign({},e);return t.children=null,t.parent=null,t}},{key:"getItemAppDataValue",value:function(e,t){var n=e.content.appData&&e.content.appData["org.standardnotes.sn"];return n?n[t]:null}},{key:"activateThemes",value:function(e){if(this.loggingEnabled&&console.log("Incoming themes",e),this.activeThemes.sort().toString()!=e.sort().toString()){var t=e||[],n=[],i=!0,r=!1,a=void 0;try{for(var s,o=this.activeThemes[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var l=s.value;e.includes(l)?t=t.filter(function(e){return e!=l}):n.push(l)}}catch(e){r=!0,a=e}finally{try{!i&&o.return&&o.return()}finally{if(r)throw a}}this.loggingEnabled&&(console.log("Deactivating themes:",n),console.log("Activating themes:",t));var u=!0,c=!1,f=void 0;try{for(var m,d=n[Symbol.iterator]();!(u=(m=d.next()).done);u=!0){var h=m.value;this.deactivateTheme(h)}}catch(e){c=!0,f=e}finally{try{!u&&d.return&&d.return()}finally{if(c)throw f}}this.activeThemes=e;var p=!0,v=!1,g=void 0;try{for(var y,x=t[Symbol.iterator]();!(p=(y=x.next()).done);p=!0){var b=y.value;if(b){var E=document.createElement("link");E.id=btoa(b),E.href=b,E.type="text/css",E.rel="stylesheet",E.media="screen,print",E.className="custom-theme",document.getElementsByTagName("head")[0].appendChild(E)}}}catch(e){v=!0,g=e}finally{try{!p&&x.return&&x.return()}finally{if(v)throw g}}}}},{key:"themeElementForUrl",value:function(e){return Array.from(document.getElementsByClassName("custom-theme")).slice().find(function(t){return t.id==btoa(e)})}},{key:"deactivateTheme",value:function(e){var t=this.themeElementForUrl(e);t&&(t.disabled=!0,t.parentNode.removeChild(t))}},{key:"generateUUID",value:function(){var e=window.crypto||window.msCrypto;if(e){var t=new Uint32Array(4);e.getRandomValues(t);var n=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){n++;var i=t[n>>3]>>n%8*4&15;return("x"==e?i:3&i|8).toString(16)})}var i=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(i+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==e?t:3&t|8).toString(16)})}}]),e}();void 0!==e&&void 0!==e.exports&&(e.exports=a),window&&(window.ComponentManager=a)},function(e,t,n){"use strict";function i(e,t,n,i,r,a,s){try{var o=e[a](s),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){function s(e){i(l,r,a,s,o,"next",e)}function o(e){i(l,r,a,s,o,"throw",e)}var l=e.apply(t,n);s(void 0)})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}n.d(t,"a",function(){return u});var l=n(0),u=function(){function e(t){var n=t.filesafe,i=t.getElementsBySelector,r=t.preprocessElement,s=t.insertElement;a(this,e),this.filesafe=n,this.getElementsBySelector=i,this.insertElement=s,this.preprocessElement=r,this.uuidToFileTempUrlAndTypeMapping={},this.currentlyLoadingIds=[],this.statusElementMapping={},this.fileTypeToElementType={"image/png":"img","image/jpg":"img","image/jpeg":"img","image/gif":"img","image/tiff":"img","image/bmp":"img","video/mp4":"video","audio/mpeg":"audio","audio/mp3":"audio"}}return o(e,[{key:"fileTypeForElementType",value:function(e){return this.fileTypeToElementType[e.toLowerCase()]}},{key:"loadFilesafeElements",value:function(){var e=this.getElementsBySelector("*[fsplaceholder]"),t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;this.loadFilesafeElement(s)}}catch(e){n=!0,i=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}}},{key:"loadFilesafeElement",value:function(){function e(e){return t.apply(this,arguments)}var t=r(regeneratorRuntime.mark(function e(t){var n,i,r,a,s,o,u,c,f,m,d,h=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.getAttribute("fsid"),i=t.getAttribute("fsname"),!(r=this.uuidToFileTempUrlAndTypeMapping[n])){e.next=6;break}return this.insertMediaElement({url:r.url,fsid:n,fileType:r.fileType,fsname:r.fsname,fsElement:t}),e.abrupt("return");case 6:if(!this.currentlyLoadingIds.includes(n)){e.next=8;break}return e.abrupt("return");case 8:if(a=this.filesafe.findFileDescriptor(n)){e.next=13;break}return this.setStatus("Unable to find file ".concat(n,"."),t,n,i,!0),console.log("Can't find descriptor with id",n),e.abrupt("return",{success:!1});case 13:if(s='[fsid="'.concat(a.uuid,'"][fscollapsable]'),o=document.querySelectorAll("img".concat(s,", figure").concat(s,", video").concat(s,", audio").concat(s)),!(o.length>0)){e.next=18;break}return console.log("File already exists"),e.abrupt("return",{success:!1});case 18:return u=function(){h.currentlyLoadingIds.splice(h.currentlyLoadingIds.indexOf(n),1)},this.currentlyLoadingIds.push(n),this.setStatus("Downloading file...",t,n,i),e.next=23,l.a.sleep(.05);case 23:return e.next=25,this.filesafe.downloadFileFromDescriptor(a).catch(function(e){h.setStatus("Unable to download file ".concat(n,"."),t,n,i)});case 25:if(c=e.sent){e.next=28;break}return e.abrupt("return");case 28:return this.setStatus("Decrypting file...",t,n,i),e.next=31,l.a.sleep(.05);case 31:return e.next=33,this.filesafe.decryptFile({fileDescriptor:a,fileItem:c}).catch(function(e){h.setStatus("Unable to decrypt file ".concat(n,"."),t,n,i)});case 33:if(f=e.sent){e.next=36;break}return e.abrupt("return");case 36:return this.setStatus(null,t,n),e.next=39,l.a.sleep(.05);case 39:return m=a.content.fileType,d=this.filesafe.createTemporaryFileUrl({base64Data:f.decryptedData,dataType:m}),this.insertMediaElement({url:d,fsid:n,fileType:m,fsname:i,fsElement:t}),u(),this.uuidToFileTempUrlAndTypeMapping[n]={url:d,fileType:m,fsname:i},e.abrupt("return",{success:!0});case 45:case"end":return e.stop()}},e,this)}));return e}()},{key:"insertMediaElement",value:function(e){var t,n=e.url,i=e.fsid,r=e.fsname,a=e.fileType,s=e.fsElement,o=this.fileTypeForElementType(a);return t="img"==o?this.createImageElement({url:n,fsid:i,fsname:r,fsElement:s}):"video"==o?this.createVideoElement({url:n,fsid:i,fileType:a,fsname:r,fsElement:s}):"audio"==o?this.createAudioElement({url:n,fsid:i,fsname:r}):this.createDownloadElement({url:n,fsid:i,fileType:a,fsname:r,fsElement:s}),this.insertElementNearElement(t,s),s.remove(),!0}},{key:"wrapElementInTag",value:function(e){var t=e.element,n=e.tagName,i=e.fsid,r=e.fsname,a=document.createElement(n);return a.setAttribute("fsid",i),a.setAttribute("fsname",r),a.setAttribute("fscollapsable",!0),a.setAttribute("contenteditable",!0),a.append(t),a}},{key:"basicwrapElementInTag",value:function(e,t){var n=document.createElement(t);return n.append(e),n}},{key:"createImageElement",value:function(e){var t=e.url,n=e.fsid,i=e.fsname,r=e.fsElement,a=document.createElement("img");return a.setAttribute("src",t),a.setAttribute("srcset","".concat(t," 2x")),a.setAttribute("fsid",n),a.setAttribute("fsname",i),a.setAttribute("fscollapsable",!0),r.getAttribute("width")&&(a.setAttribute("width",r.getAttribute("width")),a.setAttribute("height",r.getAttribute("height"))),a}},{key:"createVideoElement",value:function(e){var t=e.url,n=e.fsid,i=e.fileType,r=e.fsname,a=e.fsElement,s=document.createElement("video");s.setAttribute("controls",!0),s.setAttribute("fsid",n),s.setAttribute("fsname",r),s.setAttribute("fscollapsable",!0),a.getAttribute("width")&&(s.setAttribute("width",a.getAttribute("width")),s.setAttribute("height",a.getAttribute("height")));var o=document.createElement("source");return o.setAttribute("src",t),o.setAttribute("type",i),s.append(o),this.wrapElementInTag({element:s,tagName:"p",fsid:n,fsname:r})}},{key:"createDownloadElement",value:function(e){var t=e.url,n=e.fsid,i=(e.fileType,e.fsname),r=(e.fsElement,document.createElement("a"));return r.setAttribute("fsid",n),r.setAttribute("fsname",i),r.setAttribute("ghost","true"),r.setAttribute("fscollapsable",!0),r.setAttribute("href",t),r.textContent="".concat(i),r}},{key:"createAudioElement",value:function(e){var t=e.url,n=e.fsid,i=e.fsname,r=document.createElement("audio");return r.setAttribute("src",t),r.setAttribute("controls",!0),r.setAttribute("fsid",n),r.setAttribute("fsname",i),r.setAttribute("fscollapsable",!0),this.wrapElementInTag({element:r,tagName:"p",fsid:n,fsname:i})}},{key:"setStatus",value:function(e,t,n,i,r){if(n){var a=this.statusElementMapping[n];a&&(a.remove(),delete this.statusElementMapping[n])}if(e){var s=document.createElement("label");return s.setAttribute("id",n),s.setAttribute("ghost","true"),s.setAttribute("contenteditable",!1),s.style.fontWeight="bold",s.textContent=e,r&&(s.style.userSelect="all"),s=this.insertElementNearElement(s,t),n&&(this.statusElementMapping[n]=s),s}}},{key:"insertStatusAtCursor",value:function(e){var t=Math.random().toString(36).substring(7);return this.setStatus(e,null,t),t}},{key:"removeCursorStatus",value:function(e){var t=this.getElementsBySelector("#".concat(e));t.length>0&&t[0].remove()}},{key:"insertElementNearElement",value:function(e,t){var n=this.preprocessElement(e),i="child";if("figure"==n.tagName.toLowerCase()){var r=t.closest("p");r&&(t=r,i="afterend")}return this.insertElement(n,t,i),n}}]),e}()},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}n.d(t,"a",function(){return s});var s=function(){function e(t){var n=t.patterns,r=t.afterExpand,a=t.beforeExpand,s=t.getCurrentLineText,o=t.getPreviousLineText,l=t.replaceText;i(this,e),this.patterns=n,this.afterExpand=r,this.beforeExpand=a,this.getCurrentLineText=s,this.getPreviousLineText=o,this.replaceText=l}return a(e,[{key:"onKeyUp",value:function(e){var t=(e.key,e.isSpace),n=e.isEnter;(t||n)&&this.searchPatterns({searchPreviousLine:n})}},{key:"searchPatterns",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.searchPreviousLine;e=n?this.getPreviousLineText():this.getCurrentLineText();var i=!0,r=!1,a=void 0;try{for(var s,o=this.patterns[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var l=s.value,u=l.regex.exec(e);if(u){var c=u[0];if(c){var f=l.callback(c);this.replaceSelection(l.regex,f,n)}}}}catch(e){r=!0,a=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}}},{key:"replaceSelection",value:function(e,t,n){this.beforeExpand&&this.beforeExpand(),this.replaceText({regex:e,replacement:t,previousLine:n}),this.afterExpand&&this.afterExpand()}}]),e}()},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}n.d(t,"a",function(){return s});var s=function(){function e(){i(this,e)}return a(e,null,[{key:"expandedFilesafeSyntax",value:function(e){var t=this;return e.replace(this.FilesafeSyntaxPattern,function(e){return t.filesafeSyntaxToHtmlElement(e)})}},{key:"removeFilesafeSyntaxFromHtml",value:function(e){return e.replace(this.FilesafeSyntaxPattern,function(e){return""})}},{key:"insertionSyntaxForFileDescriptor",value:function(e){return"[FileSafe:".concat(e.uuid,":").concat(e.content.fileName,"]")}},{key:"filesafeSyntaxToHtmlElement",value:function(e){e=e.replace("<p>",""),e=e.replace("</p>",""),e=e.replace("[","").replace("]","");var t=e.split(":"),n=t[1],i=t[2],r=t[3],a="";if(r){var s=r.split("x");a="width=".concat(s[0]," height=").concat(s[1])}return"<p fsplaceholder=true style='display: none;' fscollapsable=true ghost=true fsid=".concat(n," fsname=").concat(i," ").concat(a,"></p>")}},{key:"collapseFilesafeSyntax",value:function(e){var t=(new DOMParser).parseFromString(e,"text/html"),n=t.querySelectorAll("*[fscollapsable]"),i=!0,r=!1,a=void 0;try{for(var s,o=n[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var l=s.value,u=l.getAttribute("fsid"),c=l.getAttribute("fsname"),f=l.getAttribute("width"),m=l.getAttribute("height"),d=["FileSafe",u,c];if(f||m){var h="".concat(f,"x").concat(m);d.push(h)}var p="<p>[".concat(d.join(":"),"]</p>");l.insertAdjacentHTML("afterend",p),l.remove()}}catch(e){r=!0,a=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}return t.querySelectorAll("*[ghost]").forEach(function(e){e.remove()}),t.body.innerHTML}}]),e}();!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(s,"FilesafeSyntaxPattern",/(<p>)?\[FileSafe[^\]]*\](<\/p>)?/g)},function(e,t){e.exports=require("filesafe-js")},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.d(t,"a",function(){return r});var r=function e(t){var n=t.insertRawText,r=t.onReceiveNote,a=t.setEditorRawText,s=t.getCurrentLineText,o=t.getPreviousLineText,l=t.replaceText,u=t.getElementsBySelector,c=t.insertElement,f=t.preprocessElement,m=t.clearUndoHistory;i(this,e),this.insertRawText=n,this.onReceiveNote=r,this.setEditorRawText=a,this.getCurrentLineText=s,this.getPreviousLineText=o,this.replaceText=l,this.getElementsBySelector=u,this.insertElement=c,this.preprocessElement=f,this.clearUndoHistory=m}}]);